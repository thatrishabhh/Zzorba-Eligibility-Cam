<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Zzorba Financial Consultant Services</title>
    <!-- Make it mobile-friendly -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Enhanced Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Icons & Animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

    <!-- PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --primary: #00733c;
            --primary-light: #00a050;
            --primary-dark: #005a2e;
            --primary-glow: rgba(0, 115, 60, 0.3);
            --secondary: #6366f1;
            --secondary-light: #818cf8;
            --accent: #f59e0b;
            --accent-light: #fbbf24;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --dark: #0f172a;
            --medium: #475569;
            --light: #f8fafc;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.3);
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-success: linear-gradient(135deg, #00d2ff 0%, #3a47d5 100%);
            --gradient-warm: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --shadow-soft: 0 10px 40px rgba(0, 0, 0, 0.08);
            --shadow-glow: 0 20px 60px rgba(102, 126, 234, 0.2);
            --transition-smooth: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Space Grotesk', -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
            line-height: 1.3;
            position: relative;
            overflow-x: hidden;
        }

        /* Animated Background Pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(255, 219, 98, 0.3) 0%, transparent 50%);
            animation: floatingGradient 20s ease infinite;
            z-index: -1;
        }

        @keyframes floatingGradient {

            0%,
            100% {
                transform: translate(0, 0) rotate(0deg);
            }

            33% {
                transform: translate(-20px, -20px) rotate(120deg);
            }

            66% {
                transform: translate(20px, -10px) rotate(240deg);
            }
        }

        /* Ultra-Wide Container */
        .main-wrapper {
            max-width: 1280px;
            margin: 0 auto;
            padding: 2rem;
            perspective: 1000px;
        }

        /* Glassmorphic Header */
        .premium-header {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 1.5rem 2.5rem;
            margin-bottom: 3rem;
            box-shadow: var(--shadow-glow);
            animation: slideDown 0.8s ease;
            position: relative;
            overflow: hidden;
        }

        .premium-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            to {
                left: 100%;
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
            position: relative;
            z-index: 1;
        }

        .logo-container img {
            height: 100px;
            display: block;
            /* Corrected from 'Circle' */
            border: 2px solid;
            border-radius: 5px;
            border-image: linear-gradient(to right, #FFD700 0%, #B8860B 50%, #FFD700 100%) 1;
        }

        .header-title {
            text-align: center;
            flex-grow: 1;
        }

        .header-title h1 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 2.2rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.25rem;
            letter-spacing: -1px;
        }

        .header-subtitle {
            color: var(--medium);
            font-size: 1rem;
            font-weight: 400;
        }

        .version-badge {
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.9rem;
            box-shadow: 0 5px 20px rgba(245, 158, 11, 0.3);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            animation: float 3s ease-in-out infinite;
            flex-shrink: 0;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-soft);
            transition: var(--transition-smooth);
            animation: fadeInUp 0.6s ease backwards;
            position: relative;
            overflow: hidden;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid transparent;
            background: linear-gradient(90deg, var(--primary) 0%, transparent 100%);
            background-clip: padding-box;
            border-image: linear-gradient(90deg, var(--primary) 0%, transparent 100%) 1;
        }

        .section-icon {
            width: 50px;
            height: 50px;
            background: var(--gradient-primary);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.3rem;
            box-shadow: 0 5px 20px rgba(92, 117, 228, 0.3);
        }

        .section-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.6rem;
            font-weight: 600;
            color: var(--dark);
        }

        .type-selector-container {
            display: flex;
            gap: 2rem;
            margin: 2rem 0;
            justify-content: center;
        }

        .type-selector-card {
            flex: 1;
            max-width: 300px;
            position: relative;
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .type-selector-input {
            position: absolute;
            opacity: 0;
        }

        .type-selector-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            background: white;
            border: 3px solid transparent;
            border-radius: 20px;
            text-align: center;
            transition: var(--transition-smooth);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        }

        .type-selector-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--secondary);
            margin-bottom: 1rem;
            transition: var(--transition-smooth);
        }

        .type-selector-input:checked+.type-selector-label {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-color: var(--primary);
            transform: scale(1.05);
            box-shadow: 0 10px 40px rgba(0, 115, 60, 0.2);
        }

        .type-selector-input:checked+.type-selector-label .type-selector-icon {
            background: var(--gradient-primary);
            color: white;
            transform: rotate(360deg);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }

        .input-group {
            position: relative;
        }

        .input-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-weight: 500;
            color: var(--dark);
            font-size: 0.95rem;
        }

        .input-field {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            font-size: 1rem;
            background: white;
            transition: var(--transition-smooth);
            font-family: 'Inter', sans-serif;
        }

        .input-field.auto-calculated {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border-color: var(--success);
            font-weight: 600;
            color: var(--primary-dark);
        }

        .input-hint {
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: var(--medium);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .premium-table-container {
            overflow-x: auto;
            border-radius: 20px;
            box-shadow: var(--shadow-soft);
            margin: 2rem 0;
            background: white;
            -webkit-overflow-scrolling: touch;
        }

        .premium-table-container::-webkit-scrollbar {
            height: 8px;
        }

        .premium-table-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }

        .premium-table-container::-webkit-scrollbar-thumb {
            background: var(--secondary-light);
            border-radius: 10px;
        }

        .premium-table-container::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }

        .premium-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }

        .premium-table thead {
            background: var(--gradient-primary);
        }

        .premium-table th {
            color: white;
            padding: 1.25rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .premium-table td {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #f1f5f9;
            color: var(--dark);
        }

        .premium-table input,
        .premium-table select {
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
            transition: var(--transition-smooth);
            width: 100%;
        }

        .premium-table select:disabled {
            background: #f3f4f6;
            color: #9ca3af;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-smooth);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            font-size: 1rem;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.3);
        }

        .btn-add {
            background: linear-gradient(135deg, var(--success), #34d399);
            color: white;
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #f87171);
            color: white;
            padding: 0.75rem;
            border-radius: 12px;
        }

        .floating-actions {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 1.25rem 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            display: flex;
            gap: 1.5rem;
            z-index: 1000;
            animation: slideUp 0.8s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 9999;
            padding: 2rem;
            overflow-y: auto;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-container {
            background: white;
            border-radius: 30px;
            width: 100%;
            max-width: 1400px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: modalSlide 0.4s ease;
            box-shadow: 0 25px 100px rgba(0, 0, 0, 0.3);
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: var(--gradient-primary);
            padding: 2rem 3rem;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: var(--transition-smooth);
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            flex: 1;
            padding: 3rem;
            overflow-y: auto;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
        }

        /* Result Cards */
        .result-card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-soft);
            animation: fadeInUp 0.5s ease backwards;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 1.1rem;
            animation: pulse 2s infinite;
        }

        .status-eligible {
            background: linear-gradient(135deg, #10b981, #34d399);
            color: white;
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.3);
        }

        .status-review {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            color: white;
            box-shadow: 0 5px 20px rgba(245, 158, 11, 0.3);
        }

        .status-ineligible {
            background: linear-gradient(135deg, #ef4444, #f87171);
            color: white;
            box-shadow: 0 5px 20px rgba(239, 68, 68, 0.3);
        }

        .bt-suggestion {
            background: linear-gradient(135deg, #fffbeb, #fef3c7);
            border-left: 5px solid var(--warning);
            color: #b45309;
            padding: 1.25rem;
            border-radius: 15px;
            margin-top: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-weight: 500;
            font-size: 1rem;
        }

        .bt-suggestion i {
            font-size: 1.5rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .metric-card {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-left: 5px solid var(--primary);
            border-radius: 15px;
            padding: 1.5rem;
            transition: var(--transition-smooth);
        }

        .metric-label {
            font-size: 0.9rem;
            color: var(--medium);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-dark);
        }

        .lender-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .lender-pill {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #ddd6fe, #c4b5fd);
            border: 2px solid #8b5cf6;
            color: #5b21b6;
            border-radius: 50px;
            font-weight: 600;
            transition: var(--transition-smooth);
            animation: fadeIn 0.5s ease backwards;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            text-align: center;
        }

        .loading-spinner {
            width: 80px;
            height: 80px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 2rem;
        }

        .loading-text {
            color: white;
            font-size: 1.2rem;
            font-weight: 500;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .error-container {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            border: 2px solid var(--danger);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            animation: shake 0.5s ease;
        }

        .error-list {
            list-style: none;
            padding: 0;
        }

        .error-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
            color: var(--danger);
            font-weight: 500;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-10px);
            }

            75% {
                transform: translateX(10px);
            }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-wrapper {
                padding: 1.5rem;
            }

            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 1.5rem;
            }

            .form-grid {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .main-wrapper {
                padding: 1rem;
            }

            .premium-header {
                padding: 1.5rem;
            }

            .glass-card,
            .modal-body,
            .result-card {
                padding: 1.5rem;
            }

            .header-title h1 {
                font-size: 1.6rem;
            }

            .header-subtitle {
                font-size: 0.9rem;
            }

            .type-selector-container {
                flex-direction: column;
                gap: 1rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .floating-actions {
                flex-direction: column;
                width: calc(100% - 2rem);
                left: 1rem;
                transform: none;
                bottom: 1rem;
                padding: 1rem;
                gap: 0.75rem;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .modal-overlay {
                padding: 0.5rem;
            }

            .modal-header {
                padding: 1.5rem;
            }

            .modal-header h2 {
                font-size: 1.2rem;
            }
        }

        @media print {
            body {
                background: white;
            }

            .floating-actions,
            .modal-footer,
            .modal-close {
                display: none !important;
            }
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gradient-primary);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
    </style>
</head>

<body>
    <div class="main-wrapper">
        <header class="premium-header">
            <div class="header-content">
                <div class="logo-container">
                    <a href="https://zzorba.com" target="_blank" rel="noopener">
                        <!-- Corrected logo source to a reliable, CORS-friendly URL -->
                        <img src="https://zzorba.com/wp-content/uploads/2021/02/logo2.jpg" alt="Zzorba Logo">
                    </a>
                </div>
                <div class="header-title">
                    <h1 class="animate__animated animate__fadeIn">Zzorba Financial Consultant Services</h1>
                    <p class="header-subtitle animate__animated animate__fadeIn animate__delay-2">
                        Comprehensive Eligibility Assessment
                    </p>
                </div>
                <div class="version-badge animate__animated animate__bounceIn animate__delay-2s">
                    <i class="fas fa-info-circle"></i>
                    <a href="https://zzorba.com/contact-us/" target="_blank" rel="noopener"
                        style="color: rgb(255, 255, 255); text-decoration: none;">
                        <span>Info & Contact</span>
                    </a>
                </div>
            </div>
        </header>

        <div id="errorContainer" class="error-container" style="display:none;">
            <ul id="errorList" class="error-list"></ul>
        </div>

        <!-- Customer Type -->
        <div class="glass-card">
            <div class="section-header">
                <div class="section-icon"><i class="fas fa-user-circle"></i></div>
                <h2 class="section-title">Select Customer Profile</h2>
            </div>

            <div class="type-selector-container">
                <div class="type-selector-card">
                    <input type="radio" id="typeSalaried" name="customerType" value="salaried"
                        class="type-selector-input" checked>
                    <label for="typeSalaried" class="type-selector-label">
                        <div class="type-selector-icon"><i class="fas fa-briefcase"></i></div>
                        <div class="type-selector-title">Salaried Professional</div>
                        <div class="type-selector-desc">Employees with regular payroll</div>
                    </label>
                </div>

                <div class="type-selector-card">
                    <input type="radio" id="typeBusiness" name="customerType" value="business"
                        class="type-selector-input">
                    <label for="typeBusiness" class="type-selector-label">
                        <div class="type-selector-icon"><i class="fas fa-store"></i></div>
                        <div class="type-selector-title">Business Owner</div>
                        <div class="type-selector-desc">Self-employed / Proprietor</div>
                    </label>
                </div>
            </div>
        </div>

        <!-- Basic Info -->
        <div class="glass-card">
            <div class="section-header">
                <div class="section-icon"><i class="fas fa-id-card"></i></div>
                <h2 class="section-title">Basic Information</h2>
            </div>

            <div class="form-grid">
                <div class="input-group">
                    <label class="input-label"><i class="fas fa-user-tie"></i> Full Name</label>
                    <input type="text" id="custName" class="input-field" placeholder="Full name">
                </div>

                <div class="input-group">
                    <label class="input-label"><i class="fas fa-mobile-alt"></i> Mobile</label>
                    <input type="tel" id="custMobile" class="input-field" maxlength="10" placeholder="10-digit mobile">
                </div>

                <div class="input-group">
                    <label class="input-label"><i class="fas fa-envelope"></i> Email</label>
                    <input type="email" id="custEmail" class="input-field" placeholder="email@example.com">
                </div>

                <div class="input-group">
                    <label class="input-label"><i class="fas fa-map-marker-alt"></i> Location</label>
                    <input type="text" id="location" class="input-field" placeholder="City/Region">
                </div>
            </div>
        </div>

        <!-- Salaried -->
        <div id="salariedSection" class="glass-card">
            <div class="section-header">
                <div class="section-icon"><i class="fas fa-building"></i></div>
                <h2 class="section-title">Employment & Financial Details</h2>
            </div>

            <div class="form-grid">
                <!-- DOB for Salaried -->
                <div class="input-group">
                    <label class="input-label"><i class="fas fa-birthday-cake"></i> Date of Birth</label>
                    <input type="date" id="dob" class="input-field" max="">
                    <div class="input-hint"><i class="fas fa-info-circle"></i> Select your DOB (cannot be in the future)
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label"><i class="fas fa-user-clock"></i> Age (calculated)</label>
                    <input type="number" id="calculatedAge" class="input-field auto-calculated" readonly>
                    <div id="ageNote" class="input-hint" style="display:none;"></div>
                </div>

                <div class="input-group">
                    <label class="input-label">₹ Net Monthly Salary</label>
                    <input type="number" id="salary" class="input-field" placeholder="50000" min="0">
                    <div class="input-hint"><i class="fas fa-info-circle"></i> Take-home salary</div>
                </div>

                <div class="input-group">
                    <label class="input-label"><i class="fas fa-sitemap"></i> Company Category</label>
                    <select id="companyCat" class="input-field">
                        <optgroup label="High-Tier (Best FOIR)">
                            <option value="Government">Government</option>
                            <option value="Super Cat A">Super Cat A</option>
                        </optgroup>
                        <optgroup label="Mid-Tier">
                            <option value="Cat A">Cat A</option>
                            <option value="Cat B">Cat B</option>
                            <option value="Cat C">Cat C</option>
                        </optgroup>
                        <optgroup label="Lower-Tier">
                            <option value="Cat D">Cat D</option>
                            <option value="Nonlisted">Nonlisted</option>
                        </optgroup>
                    </select>
                </div>

                <div class="input-group">
                    <label class="input-label">% FOIR Allowed</label>
                    <input type="number" id="foirAllowed" class="input-field auto-calculated" readonly>
                </div>

                <div class="input-group">
                    <label class="input-label"><i class="fas fa-clock"></i> Job Tenure (months)</label>
                    <input type="number" id="jobTenure" class="input-field" min="0">
                </div>

                <div class="input-group">
                    <label class="input-label"><i class="fas fa-award"></i> Total Experience (years)</label>
                    <input type="number" id="totalExp" class="input-field" min="0">
                </div>

                <div class="input-group">
                    <label class="input-label"><i class="fas fa-piggy-bank"></i> PF Deduction</label>
                    <select id="pfDed" class="input-field">
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                    </select>
                </div>

                <div class="input-group">
                    <label class="input-label"><i class="fas fa-file-invoice-dollar"></i> TDS Deducted</label>
                    <select id="tdsDed" class="input-field">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>

                <div class="input-group">
                    <label class="input-label"><i class="fas fa-at"></i> Official Email?</label>
                    <select id="hasOfficialEmail" class="input-field">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Business -->
        <div id="businessSection" class="glass-card" style="display:none;">
            <div class="section-header">
                <div class="section-icon"><i class="fas fa-chart-line"></i></div>
                <h2 class="section-title">Business Financial Details</h2>
            </div>

            <div class="form-grid">
                <!-- DOB for Business -->
                <div class="input-group">
                    <label class="input-label"><i class="fas fa-birthday-cake"></i> Date of Birth</label>
                    <input type="date" id="dobBusiness" class="input-field" max="">
                    <div class="input-hint"><i class="fas fa-info-circle"></i> Select your DOB (cannot be in the future)
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label"><i class="fas fa-user-clock"></i> Age (calculated)</label>
                    <input type="number" id="calculatedAgeBusiness" class="input-field auto-calculated" readonly>
                    <div id="ageNoteBusiness" class="input-hint" style="display:none;"></div>
                </div>

                <div class="input-group">
                    <label class="input-label"><i class="fas fa-coins"></i> Annual Turnover</label>
                    <input type="number" id="turnover" class="input-field" min="0">
                </div>

                <div class="input-group">
                    <label class="input-label"><i class="fas fa-chart-pie"></i> Net Annual Profit</label>
                    <input type="number" id="profit" class="input-field" min="0">
                </div>

                <div class="input-group">
                    <label class="input-label"><i class="fas fa-receipt"></i> GST Registered?</label>
                    <select id="gst" class="input-field">
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                    </select>
                </div>

                <div class="input-group">
                    <label class="input-label"><i class="fas fa-file-alt"></i> ITR Filed?</label>
                    <select id="itr" class="input-field">
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                    </select>
                </div>

                <div class="input-group">
                    <label class="input-label"><i class="fas fa-certificate"></i> Business License</label>
                    <select id="license" class="input-field">
                        <option value="N/A">Not Available</option>
                        <option value="Trade License">Trade License</option>
                        <option value="Shop">Shop Act</option>
                        <option value="Gumasta">Gumasta Certificate</option>
                        <option value="Food">Food License</option>
                        <option value="MSME">MSME certificate</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Compliance -->
        <div class="glass-card">
            <div class="section-header">
                <div class="section-icon"><i class="fas fa-clipboard-check"></i></div>
                <h2 class="section-title">Compliance & Documentation</h2>
            </div>

            <div class="form-grid">
                <div class="input-group">
                    <label class="input-label"><i class="fas fa-id-card"></i> Address Proof</label>
                    <select id="addrProof" class="input-field">
                        <option value="Aadhaar Card">Aadhaar Card</option>
                        <option value="Passport">Passport</option>
                        <option value="Driving License">Driving License</option>
                        <option value="Voter ID">Voter ID</option>
                        <option value="Electricity Bill">Electricity Bill (Weak)</option>
                        <option value="Rent Agreement">Rent Agreement (Weak)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label class="input-label"><i class="fas fa-check-circle"></i> Address Proof Available?</label>
                    <select id="addrDoc" class="input-field">
                        <option value="yes">Yes</option>
                        <option value="no">No (Special Case)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label class="input-label"><i class="fas fa-hand-holding-usd"></i> Recent Funding (3m)</label>
                    <select id="recentFunding" class="input-field">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>

                <div class="input-group">
                    <label class="input-label"><i class="fas fa-credit-card"></i> Live Unsecured Loans</label>
                    <select id="liveUnsecuredLoans" class="input-field">
                        <option value="0">None</option>
                        <option value="less_than_3">1-2</option>
                        <option value="3_or_more">3+</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Loans -->
        <div class="glass-card">
            <div class="section-header">
                <div class="section-icon"><i class="fas fa-list-alt"></i></div>
                <h2 class="section-title">Existing Bank Liabilities</h2>
            </div>

            <div class="premium-table-container">
                <table class="premium-table" id="loanTable">
                    <thead>
                        <tr>
                            <th>Loan Type</th>
                            <th>Party</th>
                            <th>Obligation %</th>
                            <th>Sanction</th>
                            <th>EMI</th>
                            <th>Tenure (m)</th>
                            <th>Rate (%)</th>
                            <th>BT Option</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div style="text-align:center; margin-top:1.5rem;">
                <button class="btn btn-add" onclick="addLoanRow()"><i class="fas fa-plus-circle"></i> Add New
                    Loan</button>
            </div>
        </div>
    </div>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <!-- Floating Actions -->
    <div class="floating-actions">
        <button class="btn btn-primary" onclick="resetForm()">
            <i class="fas fa-redo"></i> Reset
        </button>
        <button class="btn btn-success" onclick="calculateEligibility()">
            <i class="fas fa-calculator"></i> Calculate Now
        </button>
    </div>

    <!-- Modal -->
    <div id="resultsModal" class="modal-overlay" aria-hidden="true">
        <div class="modal-container">
            <div class="modal-header">
                <h2><i class="fas fa-chart-bar"></i> Comprehensive Assessment Report</h2>
                <div>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div class="modal-body" id="modalContent">
                <!-- dynamic -->
            </div>
            <div class="modal-footer"
                style="display:flex; gap:12px; justify-content:flex-end; padding:1rem 2rem; background:white;">
                <button class="btn btn-primary" onclick="generateAndDisplayReport()"><i class="fas fa-file-pdf"></i>
                    Generate PDF Report</button>
                <button class="btn btn-success" onclick="downloadPDF()"><i class="fas fa-download"></i> Download
                    PDF</button>
                <button class="btn btn-danger" onclick="closeModal()"><i class="fas fa-times-circle"></i> Close</button>
            </div>
        </div>
    </div>

    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p class="loading-text">Processing your assessment...</p>
        </div>
    </div>

    <script>
        // Ensure jsPDF available
        window.jsPDF = window.jspdf && window.jspdf.jsPDF ? window.jspdf.jsPDF : null;

        // Global state to prevent auto-calculation interference
        let calculationCompleted = false;

        // Helper functions
        function byId(id) {
            return document.getElementById(id);
        }

        function toNum(v) {
            return Number(String(v || '').replace(/[^0-9.\-]/g, '')) || 0;
        }

        function showLoading() {
            byId('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            byId('loadingOverlay').classList.remove('active');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                maximumFractionDigits: 0
            }).format(amount || 0);
        }

        // Initialize on DOM load
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            addLoanRow();
            calculateFOIR();
            toggleCustomerFields();
        });

        // Reusable DOB listener setup function
        function setupDOBListener(dobId, ageId, noteId) {
            const dobInput = document.getElementById(dobId);
            const ageOutput = document.getElementById(ageId);
            const ageNote = document.getElementById(noteId);

            if (!dobInput || !ageOutput || !ageNote) return;

            // Set today's date as maximum selectable DOB
            const todayISO = new Date().toISOString().split('T')[0];
            dobInput.setAttribute('max', todayISO);

            dobInput.addEventListener('change', () => {
                const dob = new Date(dobInput.value);
                const today = new Date();

                if (!dobInput.value) {
                    ageOutput.value = '';
                    ageNote.style.display = 'none';
                    return;
                }

                if (dob > today) {
                    ageNote.style.display = 'block';
                    ageNote.style.color = 'var(--danger)';
                    ageNote.innerHTML = '<i class="fas fa-exclamation-circle"></i> Invalid Date — cannot be in the future.';
                    dobInput.value = '';
                    ageOutput.value = '';
                    return;
                }

                let age = today.getFullYear() - dob.getFullYear();
                const m = today.getMonth() - dob.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;
                ageOutput.value = age;

                // MERGED Age Logic: Use min age of 21 but provide warnings for 21-23
                if (age >= 21 && age < 23) {
                    ageNote.style.display = 'block';
                    ageNote.style.color = 'var(--warning)';
                    ageNote.innerHTML = '<i class="fas fa-user-friends"></i> Co-applicant may be required. Limited lenders available.';
                } else if (age < 21) {
                    ageNote.style.display = 'block';
                    ageNote.style.color = 'var(--danger)';
                    ageNote.innerHTML = '<i class="fas fa-exclamation-circle"></i> Minimum age requirement is 21 years.';
                } else if (age > 70) {
                    ageNote.style.display = 'block';
                    ageNote.style.color = 'var(--warning)';
                    ageNote.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Age exceeds typical lending criteria.';
                } else {
                    ageNote.style.display = 'none';
                }
            });
        }

        function setupEventListeners() {
            // Customer type toggle
            document.querySelectorAll('input[name="customerType"]').forEach(r =>
                r.addEventListener('change', () => {
                    toggleCustomerFields();
                    calculationCompleted = false; // Reset on type change
                })
            );

            // FOIR calculation triggers
            ['salary', 'companyCat', 'pfDed', 'tdsDed', 'hasOfficialEmail'].forEach(id => {
                const el = byId(id);
                if (el) {
                    el.addEventListener('change', calculateFOIR);
                    el.addEventListener('input', calculateFOIR);
                }
            });

            // Mobile number validation
            byId('custMobile').addEventListener('input', e => {
                e.target.value = e.target.value.replace(/\D/g, '').slice(0, 10);
            });

            // DOB and Age calculation for SALARIED
            setupDOBListener('dob', 'calculatedAge', 'ageNote');

            // DOB and Age calculation for BUSINESS
            setupDOBListener('dobBusiness', 'calculatedAgeBusiness', 'ageNoteBusiness');
        }

        function toggleCustomerFields() {
            const type = document.querySelector('input[name="customerType"]:checked').value;
            byId('salariedSection').style.display = type === 'salaried' ? 'block' : 'none';
            byId('businessSection').style.display = type === 'business' ? 'block' : 'none';
            if (type === 'salaried') {
                calculateFOIR();
            }
        }

        function calculateFOIR() {
            const salary = toNum(byId('salary').value);
            const companyCategory = byId('companyCat').value;
            const pfDed = byId('pfDed').value;
            const tdsDed = byId('tdsDed').value;
            const hasEmail = byId('hasOfficialEmail').value;

            const highTierCategories = ['Government', 'Super Cat A'];
            const midTierCategories = ['Cat A', 'Cat B', 'Cat C'];
            const lowerTierCategories = ['Cat D', 'Nonlisted'];

            let foirPercentage;

            if (highTierCategories.includes(companyCategory)) {
                if (salary < 45000) foirPercentage = 50;
                else if (salary >= 45000 && salary <= 54999) foirPercentage = 55;
                else if (salary >= 55000 && salary <= 59999) foirPercentage = 60;
                else if (salary >= 60000 && salary <= 69999) foirPercentage = 65;
                else if (salary >= 70000 && salary <= 89999) foirPercentage = 70;
                else if (salary >= 90000 && salary <= 149999) foirPercentage = 75;
                else if (salary >= 150000) foirPercentage = 75;
                else foirPercentage = 50; // default
            } else if (midTierCategories.includes(companyCategory)) {
                if (salary < 45000) foirPercentage = 45;
                else if (salary >= 45000 && salary <= 54999) foirPercentage = 50;
                else if (salary >= 55000 && salary <= 59999) foirPercentage = 55;
                else if (salary >= 60000 && salary <= 69999) foirPercentage = 60;
                else if (salary >= 70000 && salary <= 89999) foirPercentage = 65;
                else if (salary >= 90000 && salary <= 149999) foirPercentage = 70;
                else if (salary >= 150000) foirPercentage = 75;
                else foirPercentage = 45; // default
            } else if (lowerTierCategories.includes(companyCategory)) {
                if (salary < 45000) foirPercentage = 40;
                else if (salary >= 45000 && salary <= 54999) foirPercentage = 45;
                else if (salary >= 55000 && salary <= 59999) foirPercentage = 50;
                else if (salary >= 60000 && salary <= 89999) foirPercentage = 55;
                else if (salary >= 90000 && salary <= 149999) foirPercentage = 60;
                else if (salary >= 150000) foirPercentage = 65;
                else foirPercentage = 40; // default
            } else {
                foirPercentage = 45; // conservative default
            }

            // Add bonuses
            if (pfDed === 'yes' || tdsDed === 'yes') foirPercentage += 5; // deductions present
            if (hasEmail === 'yes') foirPercentage += 5; // official email bonus

            const finalFOIR = Math.min(75, Math.max(35, Math.round(foirPercentage)));
            byId('foirAllowed').value = finalFOIR;
        }

        // Loan Table Management
        const LOAN_TYPES = [
            'Personal Loan',
            'Home Loan',
            'Vehicle Loan',
            'Credit Card',
            'Od Limit',
            'Business Loan',
            'Gold Loan',
            'Other'
        ];

        function addLoanRow() {
            const tbody = document.querySelector('#loanTable tbody');
            const tr = document.createElement('tr');
            tr.style.animation = 'fadeIn 0.5s ease';
            tr.innerHTML = `
                <td>
                    <select class="loan-type">
                        ${LOAN_TYPES.map(t => `<option value="${t}">${t}</option>`).join('')}
                    </select>
                </td>
                <td>
                    <select class="loan-party">
                        <option value="Applicant">Applicant</option>
                        <option value="Co-Applicant">Co-Applicant</option>
                        <option value="Guarantor">Guarantor</option>
                    </select>
                </td>
                <td>
                    <select class="loan-obligation">
                        <option value="100">100</option>
                        <option value="50">50</option>
                        <option value="0">0</option>
                    </select>
                </td>
                <td><input type="number" class="loan-sanction" placeholder="Amount"></td>
                <td><input type="number" class="loan-emi" placeholder="EMI"></td>
                <td><input type="number" class="loan-tenure" placeholder="Months"></td>
                <td><input type="number" class="loan-rate" placeholder="%" step="0.1"></td>
                <td>
                    <select class="loan-bt">
                        <option value="No">No</option>
                        <option value="Yes">Yes</option>
                    </select>
                </td>
                <td>
                    <button class="btn btn-danger" onclick="removeLoanRow(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;

            tbody.appendChild(tr);
            setupEMICalculation(tr);
            setupLoanTypeListener(tr);
        }

        function setupLoanTypeListener(row) {
            const loanTypeSelect = row.querySelector('.loan-type');
            const btSelect = row.querySelector('.loan-bt');
            loanTypeSelect.addEventListener('change', () => {
                if (loanTypeSelect.value === 'Home Loan') {
                    btSelect.value = 'No';
                    btSelect.disabled = true;
                } else {
                    btSelect.disabled = false;
                }
            });
        }

        function setupEMICalculation(row) {
            const sanction = row.querySelector('.loan-sanction');
            const tenure = row.querySelector('.loan-tenure');
            const rate = row.querySelector('.loan-rate');
            const emi = row.querySelector('.loan-emi');
            const loanType = row.querySelector('.loan-type');

            const calculateEMI = () => {
                if (calculationCompleted) return;

                const p = toNum(sanction.value);
                const t = parseInt(tenure.value, 10) || 0;
                const r = toNum(rate.value);
                const type = loanType.value;

                if (type === 'Credit Card') {
                    if (p > 0) emi.value = Math.round(p * 0.05);
                } else if (p > 0 && t > 0 && r > 0) {
                    const monthlyRate = (r / 100) / 12;
                    const pow = Math.pow(1 + monthlyRate, t);
                    const calculatedEMI = (p * monthlyRate * pow) / (pow - 1);
                    emi.value = Math.round(calculatedEMI);
                }
            };

            [sanction, tenure, rate, loanType].forEach(el => {
                el.addEventListener('input', calculateEMI);
                el.addEventListener('change', calculateEMI);
            });
        }

        function removeLoanRow(btn) {
            const tbody = document.querySelector('#loanTable tbody');
            if (tbody.children.length > 1) {
                btn.closest('tr').remove();
            } else {
                showError(['At least one loan row is required. You can leave it blank if there are no loans.']);
            }
        }

        // Validation Functions
        function validateForm() {
            const errors = [];
            if (!byId('custName').value.trim()) errors.push('Please enter customer name');
            if (!/^[6-9]\d{9}$/.test(byId('custMobile').value.trim())) errors.push('Please enter a valid 10-digit mobile number');

            const type = document.querySelector('input[name="customerType"]:checked').value;
            if (type === 'salaried') {
                if (!byId('dob').value) errors.push('Please select date of birth for salaried profile');
                const age = toNum(byId('calculatedAge').value);
                if (age < 21 || age > 58) errors.push('Age must be between 21 and 58 for salaried employees');
                if (toNum(byId('salary').value) <= 0) errors.push('Please enter a valid monthly salary');
            } else {
                if (!byId('dobBusiness').value) errors.push('Please select date of birth for business profile');
                const age = toNum(byId('calculatedAgeBusiness').value);
                if (age < 23 || age > 70) errors.push('Age must be between 23 and 70 for business owners');
                if (toNum(byId('turnover').value) <= 0) errors.push('Please enter a valid annual turnover');
            }
            return errors;
        }

        // --- MERGED Eligibility Logic ---

        const LENDER_POOLS = {
            premium: ['HDFC Bank', 'ICICI Bank', 'Axis Bank', 'Kotak Bank', 'IndusInd Bank'],
            standard: ['Tata Capital', 'Bajaj Finance'],
            conservative: ['ABFL', 'Fullerton India', 'InCred', 'Shriram Finance', 'Chola'],
            specialist: ['L&T', 'Piramal', 'Godrej', 'Lending Kart', 'Indifie', 'Paycence']
        };

        function getNetEMI(emi, obligationPercent, btOption) {
            if (btOption === 'Yes') return 0;
            return emi * (obligationPercent / 100);
        }

        function getPersonalLoanEligibilitySalaried(data) {
            const { salary, pfDeducted, tdsDeducted, addrProof, hasAddressDoc, companyCategory, age } = data;

            // Age-based special case (from old logic)
            if (age >= 21 && age < 23) {
                return ['Bajaj'];
            }

            // Special Case: No Address Proof (from new logic)
            if (hasAddressDoc === 'no') {
                const highTierCompany = ['Government', 'Super Cat A', 'Cat A', 'Cat B', 'Cat C'].includes(companyCategory);
                if (highTierCompany) {
                    return ['HDFC Bank', 'ICICI Bank'];
                }
                return [];
            }

            let eligibleLenders = [];
            const hasPfOrTds = pfDeducted === 'yes' || tdsDeducted === 'yes';

            // PF/TDS based eligibility (from new logic)
            if (salary >= 35000) {
                if (hasPfOrTds) {
                    eligibleLenders = [...LENDER_POOLS.standard, ...LENDER_POOLS.conservative];
                } else {
                    eligibleLenders = ['InCred', 'Shriram Finance', 'Fullerton India', 'ABFL']; // More restrictive list from old logic
                }
            }

            // Address Proof based filtering (from new logic)
            const isWeakProof = ['Electricity Bill', 'Rent Agreement'].includes(addrProof);
            if (isWeakProof) {
                eligibleLenders = eligibleLenders.filter(lender => !LENDER_POOLS.premium.includes(lender));
            }

            return [...new Set(eligibleLenders)];
        }

        function getODLimitEligibilitySalaried(data) {
            const { salary, companyCategory, addrProof, hasAddressDoc, pfDeducted, tdsDeducted } = data;
            const isStrongProof = ['Aadhaar Card', 'Passport', 'Driving License', 'Voter ID'].includes(addrProof);

            // Stricter rules: OD requires strong proof and availability
            if (!isStrongProof || hasAddressDoc === 'no') {
                return [];
            }

            // New rule: Minimum salary of 50000 for OD eligibility
            if (salary < 50000) {
                return [];
            }

            // Check if there are no deductions (PF or TDS)
            const noDeductions = (pfDeducted === 'no' || pfDeducted === 'N/A') &&
                (tdsDeducted === 'no' || tdsDeducted === 'N/A');

            // If no deductions, only ABFL provides OD
            if (noDeductions) {
                return ['ABFL'];
            }

            // If deductions are present (PF or TDS), proceed with tier-based logic
            const hasDeductions = pfDeducted === 'yes' || tdsDeducted === 'yes';

            if (hasDeductions) {
                const Alltiercompany = ['Government', 'Super Cat A', 'Cat A', 'Cat B', 'Cat C', 'Cat D', 'Nonlisted'].includes(companyCategory);

                // For salary >= 1 lakh with deductions
                if (salary >= 100000) {
                    return ['Bajaj Finance', 'Tata Capital', 'ABFL'];
                }
                if (salary >= 100000 && highTierCompany) {
                    return ['Kotak bank'];
                }

                // For salary >= 50 k with deductions and good company category
                if (salary >= 50000 && Alltiercompany) {
                    return ['Bajaj Finance', 'Tata Capital', 'ABFL'];
                }

                // For salary >= 50 K with deductions (default)
                if (salary >= 50000) {
                    return ['Bajaj Finance', 'Tata Capital', 'ABFL'];
                }
            }

            return [];
        }

        function getBusinessLoanEligibility(data) {
            const { turnover, gst, itr, license, addrProof, hasAddressDoc, age } = data;

            // Age-based special case (from old logic)
            if (age >= 23 && age < 25) {
                if (turnover >= 5000000 && gst === 'yes' && itr === 'yes') return ['Bajaj', 'Chola'];
                return [];
            }

            let lenders = [];
            if (turnover >= 5000000) {
                // Combined lender list from both logic sets
                if (gst === 'yes' && license !== 'N/A') {
                    lenders.push(...['Bajaj', 'Tata', 'Chola', 'InCred', 'Paycence', 'Shriram Finance', 'Lending Kart', 'Indifie']);
                }
                if (gst === 'yes' && itr === 'yes') {
                    lenders.push(...['Bajaj', 'Tata', 'Chola', 'Indifie', 'Piramal', 'Shriram Finance', 'InCred', 'Paycence']);
                }
                if (gst === 'N/A' && itr === 'yes' && license !== 'yes') {
                    lenders.push(...['Bajaj', 'Tata', 'Chola', 'InCred', 'Paycence', 'Shriram Finance', 'Lending Kart', 'Indifie']);
                }
            }

            if (turnover >= 10000000) {
                // Combined lender list from both logic sets
                if (gst === 'yes' && itr === 'yes' && license !== 'N/A') {
                    lenders.push(...['Bajaj', 'Tata', 'Chola', 'InCred', 'Paycence', 'ABFL', 'L&T', 'Godrej', 'Shriram Finance', 'Lending Kart', 'Indifie']);
                }
                if (gst === 'N/A' && itr === 'yes' && license !== 'yes') {
                    lenders.push(...['Bajaj', 'Tata', 'Chola', 'InCred', 'Paycence', 'ABFL', 'L&T', 'Godrej', 'Shriram Finance', 'Lending Kart', 'Indifie']);
                }
            }
            // Filter out lenders if proof is weak or unavailable (from new logic)
            const isWeakProof = ['Rent Agreement'].includes(addrProof);
            if (isWeakProof || hasAddressDoc === 'no') {
                const strictLenders = ['L&T', 'Godrej', 'Piramal'];
                lenders = lenders.filter(l => !strictLenders.includes(l));
            }

            return [...new Set(lenders)];
        }

        function getBusinessODEligibility(data) {
            const { turnover, itr, addrProof, hasAddressDoc, age } = data;

            // Stricter age from new logic
            if (age < 25) return [];

            const isStrongProof = ['Aadhaar Card', 'Electricity Bill', 'Passport', 'Driving License', 'Voter ID'].includes(addrProof);
            if (!isStrongProof || hasAddressDoc === 'no') {
                return [];
            }

            if (turnover >= 10000000 && gst === 'yes' && itr === 'yes') {
                return ['Bajaj', 'Tata', 'ABFL', 'L&T', 'Godrej'];
            }
            return [];
            if (turnover >= 5000000 && gst === 'N/A' && itr === 'yes' && license !== 'yes') {
                return ['Bajaj', 'Tata'];
            }
        }


        function showError(messages) {
            const errorList = byId('errorList');
            errorList.innerHTML = messages.map(m => `<li class="error-item"><i class="fas fa-exclamation-circle"></i> ${m}</li>`).join('');
            const errorContainer = byId('errorContainer');
            errorContainer.style.display = 'block';
            errorContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function clearErrors() {
            byId('errorContainer').style.display = 'none';
            byId('errorList').innerHTML = '';
        }

        // Main Calculation Function
        function calculateEligibility() {
            try {
                clearErrors();
                showLoading();

                const errors = validateForm();
                if (errors.length > 0) {
                    hideLoading();
                    showError(errors);
                    return;
                }

                calculationCompleted = true;

                const type = document.querySelector('input[name="customerType"]:checked').value;
                const customerData = {
                    custName: byId('custName').value.trim(),
                    custMobile: byId('custMobile').value.trim(),
                    custEmail: byId('custEmail').value.trim() || 'N/A',
                    location: byId('location').value.trim(),
                    customerType: type,
                    addrProof: byId('addrProof').value,
                    hasAddressDoc: byId('addrDoc').value,
                    recentFunding: byId('recentFunding').value,
                    liveUnsecuredLoans: byId('liveUnsecuredLoans').value
                };

                let eligibilityResults = { odLimit: [], personalLoan: [], businessLoan: [] };
                let maxFOIRAmount = 0;

                if (type === 'salaried') {
                    const salary = toNum(byId('salary').value);
                    const foirAllowed = toNum(byId('foirAllowed').value);
                    maxFOIRAmount = Math.round(salary * (foirAllowed / 100));
                    Object.assign(customerData, {
                        salary, foirAllowed,
                        pfDeducted: byId('pfDed').value,
                        tdsDeducted: byId('tdsDed').value,
                        companyCategory: byId('companyCat').value,
                        hasOfficialEmail: byId('hasOfficialEmail').value,
                        age: toNum(byId('calculatedAge').value),
                        dob: byId('dob').value,
                        jobTenure: toNum(byId('jobTenure').value),
                        totalExp: toNum(byId('totalExp').value)
                    });
                    eligibilityResults.personalLoan = getPersonalLoanEligibilitySalaried(customerData);
                    eligibilityResults.odLimit = getODLimitEligibilitySalaried(customerData);
                } else {
                    const profit = toNum(byId('profit').value);
                    maxFOIRAmount = Math.round((profit / 12) * 0.5); // 50% of monthly profit
                    Object.assign(customerData, {
                        turnover: toNum(byId('turnover').value),
                        profit,
                        gst: byId('gst').value,
                        itr: byId('itr').value,
                        license: byId('license').value,
                        age: toNum(byId('calculatedAgeBusiness').value),
                        dob: byId('dobBusiness').value
                    });
                    eligibilityResults.businessLoan = getBusinessLoanEligibility(customerData);
                    eligibilityResults.odLimit = getBusinessODEligibility(customerData);
                }

                const loanRows = document.querySelectorAll('#loanTable tbody tr');
                let totalObligatedEMI = 0;
                let hasBTEligibleLoan = false;
                customerData.existingLoans = [];

                loanRows.forEach(row => {
                    const loanType = row.querySelector('.loan-type').value;
                    const emi = toNum(row.querySelector('.loan-emi').value);
                    const obligationPercent = toNum(row.querySelector('.loan-obligation').value);
                    const btOption = row.querySelector('.loan-bt').value;

                    if (emi > 0) {
                        const netEMI = getNetEMI(emi, obligationPercent, btOption);

                        customerData.existingLoans.push({
                            type: loanType,
                            party: row.querySelector('.loan-party').value,
                            obligationPercent,
                            sanction: toNum(row.querySelector('.loan-sanction').value),
                            emi,
                            netEMI, // Store for PDF
                            tenure: toNum(row.querySelector('.loan-tenure').value),
                            rate: toNum(row.querySelector('.loan-rate').value),
                            bt: btOption
                        });

                        totalObligatedEMI += netEMI;
                        if (loanType !== 'Home Loan' && btOption === 'Yes') {
                            hasBTEligibleLoan = true;
                        }
                    }
                });

                const availableEMI = Math.max(0, maxFOIRAmount - totalObligatedEMI);
                const maxEligibleLoanAmount = Math.round(availableEMI * 40);

                const FOIR_UTILIZATION_THRESHOLD = 0.90;
                let suggestBT = false;
                if (totalObligatedEMI > 0 && maxFOIRAmount > 0 && (totalObligatedEMI / maxFOIRAmount) >= FOIR_UTILIZATION_THRESHOLD && hasBTEligibleLoan) {
                    suggestBT = true;
                }

                if (maxEligibleLoanAmount < 500000) {
                    eligibilityResults.odLimit = [];
                }

                const result = {
                    status: determineStatus(eligibilityResults, maxEligibleLoanAmount, customerData.recentFunding),
                    suggestedLenders: [...new Set([...eligibilityResults.personalLoan, ...eligibilityResults.businessLoan, ...eligibilityResults.odLimit])],
                    eligibilityResults,
                    maxFOIRAmount,
                    totalExistingEMI: Math.round(totalObligatedEMI),
                    availableEMI: Math.round(availableEMI),
                    maxEligibleLoanAmount,
                    suggestBT
                };

                window.currentInputData = customerData;
                window.currentEligibilityResult = result;

                displayResults(customerData, result);
                hideLoading();

            } catch (error) {
                hideLoading();
                console.error('Calculation error:', error);
                showError(['An error occurred during calculation. Please check your inputs.']);
            }
        }

        function determineStatus(eligibility, maxLoan, recentFunding) {
            const hasAnyLoan = (eligibility.personalLoan && eligibility.personalLoan.length > 0) || (eligibility.businessLoan && eligibility.businessLoan.length > 0);
            const hasOD = eligibility.odLimit && eligibility.odLimit.length > 0;

            if (maxLoan <= 0) return 'Ineligible - High Obligations';
            if (hasAnyLoan || hasOD) {
                if (recentFunding === 'yes') return 'Review Required - Recent Funding';
                if (hasAnyLoan && hasOD) return 'Eligible - Loan + OD';
                if (hasAnyLoan) return 'Eligible - Loan Only';
                if (hasOD) return 'Eligible - OD Only';
            }
            return 'Ineligible - Criteria Not Met';
        }

        function displayResults(data, result) {
            const statusClass = result.status.includes('Eligible') ? 'status-eligible' : result.status.includes('Review') ? 'status-review' : 'status-ineligible';

            let btMessageHTML = '';
            if (result.suggestBT) {
                btMessageHTML = `
                    <div class="bt-suggestion">
                        <i class="fas fa-lightbulb"></i>
                        <div>
                            <strong>Balance Transfer Recommended:</strong> 💡 Your EMI obligations are high. A Balance Transfer (BT) on eligible loans is recommended to reduce your monthly burden and improve eligibility.
                        </div>
                    </div>`;
            }

            let modalHTML = `
                <div class="result-card">
                    <h3>Assessment Summary</h3>
                    <center>
                        <div class="${statusClass} status-indicator" style="margin-top:1rem;">
                            <i class="fas fa-check-circle"></i>
                            ${result.status}
                        </div>
                    </center>
                    ${btMessageHTML}
                </div>

                <div class="result-card">
                    <h3>Financial Metrics</h3>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Max FOIR Amount</div>
                            <div class="metric-value">${formatCurrency(result.maxFOIRAmount)}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Total Obligated EMI</div>
                            <div class="metric-value">${formatCurrency(result.totalExistingEMI)}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Available EMI for New Loan</div>
                            <div class="metric-value">${formatCurrency(result.availableEMI)}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Max Eligible Loan Amount</div>
                            <div class="metric-value">${formatCurrency(result.maxEligibleLoanAmount)}</div>
                        </div>
                    </div>
                </div>
            `;

            if (result.suggestedLenders.length > 0) {
                modalHTML += `
                    <div class="result-card">
                        <h3>Eligible Products & Lenders</h3>
                        ${result.eligibilityResults.odLimit.length > 0 ? `
                            <h4>OD Limit</h4>
                            <div class="lender-container">${result.eligibilityResults.odLimit.map(l => `<div class="lender-pill">${l}</div>`).join('')}</div>
                        ` : ''}
                        ${data.customerType === 'salaried' && result.eligibilityResults.personalLoan.length > 0 ? `
                            <h4 style="margin-top:1rem;">Personal Loan</h4>
                            <div class="lender-container">${result.eligibilityResults.personalLoan.map(l => `<div class="lender-pill">${l}</div>`).join('')}</div>
                        ` : ''}
                        ${data.customerType === 'business' && result.eligibilityResults.businessLoan.length > 0 ? `
                            <h4 style="margin-top:1rem;">Business Loan</h4>
                            <div class="lender-container">${result.eligibilityResults.businessLoan.map(l => `<div class="lender-pill">${l}</div>`).join('')}</div>
                        ` : ''}
                    </div>
                `;
            }

            byId('modalContent').innerHTML = modalHTML;
            openModal();
        }

        // Modal Control Functions
        function openModal() {
            document.body.style.overflow = 'hidden';
            byId('resultsModal').classList.add('active');
            byId('resultsModal').setAttribute('aria-hidden', 'false');
        }

        function closeModal() {
            document.body.style.overflow = '';
            byId('resultsModal').classList.remove('active');
            byId('resultsModal').setAttribute('aria-hidden', 'true');
        }

        // PDF Generation
        function generateReportContent(inputData, result) {
            if (!inputData || !result) {
                return '<div style="padding:16px">No report data available</div>';
            }

            const reportDate = new Date().toLocaleDateString('en-IN', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });

            const eligibleProducts = [];
            if (result.eligibilityResults) {
                if (result.eligibilityResults.odLimit.length > 0) {
                    eligibleProducts.push({ type: 'OD Limit', lenders: result.eligibilityResults.odLimit });
                }
                if (result.eligibilityResults.personalLoan.length > 0) {
                    eligibleProducts.push({ type: 'Personal Loan', lenders: result.eligibilityResults.personalLoan });
                }
                if (result.eligibilityResults.businessLoan.length > 0) {
                    eligibleProducts.push({ type: 'Business Loan', lenders: result.eligibilityResults.businessLoan });
                }
            }

            let profileHTML = '';
            if (inputData.customerType === 'salaried') {
                profileHTML = `
                    <tr><td style="padding: 8px; width: 40%;"><strong>Customer Type:</strong></td><td style="padding: 8px;">Salaried Professional</td></tr>
                    <tr><td style="padding: 8px;"><strong>Date of Birth:</strong></td><td style="padding: 8px;">${inputData.dob ? new Date(inputData.dob).toLocaleDateString('en-IN') : 'N/A'}</td></tr>
                    <tr><td style="padding: 8px;"><strong>Age:</strong></td><td style="padding: 8px;">${inputData.age} years</td></tr>
                    <tr><td style="padding: 8px;"><strong>Monthly Salary:</strong></td><td style="padding: 8px;">${formatCurrency(inputData.salary)}</td></tr>
                    <tr><td style="padding: 8px;"><strong>Company Category:</strong></td><td style="padding: 8px;">${inputData.companyCategory}</td></tr>
                    <tr><td style="padding: 8px;"><strong>FOIR Allowed:</strong></td><td style="padding: 8px;">${inputData.foirAllowed}%</td></tr>
                    <tr><td style="padding: 8px;"><strong>PF/TDS Deduction:</strong></td><td style="padding: 8px;">${(inputData.pfDeducted === 'yes' || inputData.tdsDeducted === 'yes') ? 'Yes' : 'No'}</td></tr>
                `;
            } else {
                profileHTML = `
                    <tr><td style="padding: 8px; width: 40%;"><strong>Customer Type:</strong></td><td style="padding: 8px;">Business Owner</td></tr>
                    <tr><td style="padding: 8px;"><strong>Date of Birth:</strong></td><td style="padding: 8px;">${inputData.dob ? new Date(inputData.dob).toLocaleDateString('en-IN') : 'N/A'}</td></tr>
                    <tr><td style="padding: 8px;"><strong>Age:</strong></td><td style="padding: 8px;">${inputData.age} years</td></tr>
                    <tr><td style="padding: 8px;"><strong>Annual Turnover:</strong></td><td style="padding: 8px;">${formatCurrency(inputData.turnover)}</td></tr>
                    <tr><td style="padding: 8px;"><strong>Annual Profit:</strong></td><td style="padding: 8px;">${formatCurrency(inputData.profit)}</td></tr>
                    <tr><td style="padding: 8px;"><strong>GST Registered:</strong></td><td style="padding: 8px;">${inputData.gst === 'yes' ? 'Yes' : 'No'}</td></tr>
                    <tr><td style="padding: 8px;"><strong>ITR Filed:</strong></td><td style="padding: 8px;">${inputData.itr === 'yes' ? 'Yes' : 'No'}</td></tr>
                `;
            }

            const statusColor = result.status.includes('Eligible') ? '#10b981' : result.status.includes('Review') ? '#f59e0b' : '#ef4444';

            let btMessagePDF = '';
            if (result.suggestBT) {
                btMessagePDF = `<div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; border-radius: 8px; margin-bottom: 25px; color: #b45309; font-size: 14px;"><strong>Balance Transfer Recommended:</strong> High EMI utilization detected. A BT on eligible loans could lower your monthly payments and improve overall eligibility.</div>`;
            }

            return `
                <div id="pdfContent" style="font-family: 'Inter', 'Space Grotesk', Arial, sans-serif; padding: 20px; background: white;">
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #667eea; padding-bottom: 20px;">
                        <img src="https://zzorba.com/wp-content/uploads/2021/02/logo2.jpg" alt="ZZORBA" style="height: 50px; margin-bottom: 10px;">
                        <h1 style="color: #0f172a; margin: 10px 0; font-size: 24px;">Eligibility Assessment Report</h1>
                        <p style="color: #64748b; margin: 5px 0;">Generated on: ${reportDate}</p>
                    </div>

                    <div style="background: linear-gradient(135deg, ${statusColor}22, ${statusColor}11); border-left: 4px solid ${statusColor}; padding: 15px; border-radius: 8px; margin-bottom: 25px;">
                        <h2 style="color: ${statusColor}; margin: 0; font-size: 20px;">
                            <strong>Status:</strong> ${result.status}
                        </h2>
                    </div>

                    ${btMessagePDF}

                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #334155; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; margin-bottom: 15px;">Customer Information</h3>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <tr><td style="padding: 8px; width: 40%;"><strong>Name:</strong></td><td style="padding: 8px;">${inputData.custName}</td></tr>
                            <tr><td style="padding: 8px;"><strong>Mobile:</strong></td><td style="padding: 8px;">${inputData.custMobile}</td></tr>
                            <tr><td style="padding: 8px;"><strong>Email:</strong></td><td style="padding: 8px;">${inputData.custEmail}</td></tr>
                            <tr><td style="padding: 8px;"><strong>Location:</strong></td><td style="padding: 8px;">${inputData.location}</td></tr>
                            <tr><td style="padding: 8px;"><strong>Address Proof:</strong></td><td style="padding: 8px;">${inputData.addrProof} (${inputData.hasAddressDoc === 'yes' ? 'Available' : 'Not Available'})</td></tr>
                        </table>
                    </div>

                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #334155; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; margin-bottom: 15px;">Financial Profile</h3>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            ${profileHTML}
                        </table>
                    </div>

                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #334155; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; margin-bottom: 15px;">Eligibility Calculation</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 3px solid #667eea;">
                                <div style="color: #64748b; font-size: 14px;">Max FOIR Amount</div>
                                <div style="color: #0f172a; font-size: 20px; font-weight: bold; margin-top: 5px;">${formatCurrency(result.maxFOIRAmount)}</div>
                            </div>
                            <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 3px solid #f59e0b;">
                                <div style="color: #64748b; font-size: 14px;">Total Obligated EMI</div>
                                <div style="color: #0f172a; font-size: 20px; font-weight: bold; margin-top: 5px;">${formatCurrency(result.totalExistingEMI)}</div>
                            </div>
                            <div style="background: #d1fae5; padding: 15px; border-radius: 8px; border-left: 3px solid #10b981;">
                                <div style="color: #64748b; font-size: 14px;">Available EMI</div>
                                <div style="color: #0f172a; font-size: 20px; font-weight: bold; margin-top: 5px;">${formatCurrency(result.availableEMI)}</div>
                            </div>
                            <div style="background: #e0e7ff; padding: 15px; border-radius: 8px; border-left: 3px solid #6366f1;">
                                <div style="color: #64748b; font-size: 14px;">Max Eligible Loan</div>
                                <div style="color: #0f172a; font-size: 20px; font-weight: bold; margin-top: 5px;">${formatCurrency(result.maxEligibleLoanAmount)}</div>
                            </div>
                        </div>
                    </div>

                    ${eligibleProducts.length > 0 ? `
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #334155; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; margin-bottom: 15px;">Eligible Products & Lenders</h3>
                        ${eligibleProducts.map(product => `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #667eea; margin-bottom: 10px;">${product.type}</h4>
                                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                                    ${product.lenders.map(l =>
                `<span style="background: #667eea; color: white; padding: 8px 16px; border-radius: 20px; font-weight: 500; font-size: 14px;">${l}</span>`
            ).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ` : '<p style="color: #94a3b8; text-align: center;">No eligible products found based on the provided criteria.</p>'}

                    ${inputData.existingLoans && inputData.existingLoans.length > 0 ? `
                        <div style="margin-bottom: 25px; page-break-inside: avoid;">
                            <h3 style="color: #334155; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; margin-bottom: 15px;">Existing Loan Details</h3>
                            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                <thead>
                                    <tr style="background: #f1f5f9;">
                                        <th style="padding: 10px; text-align: left; border: 1px solid #e2e8f0;">Loan Type</th>
                                        <th style="padding: 10px; text-align: right; border: 1px solid #e2e8f0;">Outstanding</th>
                                        <th style="padding: 10px; text-align: right; border: 1px solid #e2e8f0;">EMI</th>
                                        <th style="padding: 10px; text-align: center; border: 1px solid #e2e8f0;">Obligation</th>
                                        <th style="padding: 10px; text-align: right; border: 1px solid #e2e8f0;">Net EMI</th>
                                        <th style="padding: 10px; text-align: center; border: 1px solid #e2e8f0;">BT Option</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${inputData.existingLoans.map(loan => {
                const emiDisplay = loan.bt === 'Yes'
                    ? `<s style="color: #9ca3af;">${formatCurrency(loan.emi)}</s>`
                    : formatCurrency(loan.emi);
                return `
                                            <tr>
                                                <td style="padding: 10px; border: 1px solid #e2e8f0;">${loan.type}</td>
                                                <td style="padding: 10px; text-align: right; border: 1px solid #e2e8f0;">${formatCurrency(loan.sanction)}</td>
                                                <td style="padding: 10px; text-align: right; border: 1px solid #e2e8f0;">${emiDisplay}</td>
                                                <td style="padding: 10px; text-align: center; border: 1px solid #e2e8f0;">${loan.obligationPercent}%</td>
                                                <td style="padding: 10px; text-align: right; border: 1px solid #e2e8f0; font-weight: bold; ${loan.bt === 'Yes' ? 'color: #10b981;' : ''}">${formatCurrency(loan.netEMI)}</td>
                                                <td style="padding: 10px; text-align: center; border: 1px solid #e2e8f0; ${loan.bt === 'Yes' ? 'color: #10b981; font-weight: bold;' : ''}">${loan.bt}</td>
                                            </tr>
                                        `;
            }).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : ''}

                    <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e2e8f0; text-align: center; color: #64748b; font-size: 12px;">
                        <p>This report is generated by Zzorba Financial Consultant Services</p>
                        <p>Visit us at: <a href="https://zzorba.com" style="color: #667eea;">zzorba.com</a></p>
                    </div>
                </div>
            `;
        }

        function generateAndDisplayReport() {
            if (!window.currentInputData || !window.currentEligibilityResult) {
                alert('Please calculate eligibility first.');
                return;
            }

            const reportHTML = generateReportContent(
                window.currentInputData,
                window.currentEligibilityResult
            );

            // Replace the modal's content with the detailed report view
            byId('modalContent').innerHTML = reportHTML;
            // Rename the content div to avoid confusion if the button is clicked multiple times
            byId('modalContent').firstElementChild.id = 'pdfContent';
        }

        function downloadPDF() {
            // The content to be captured for the PDF is now consistently named 'pdfContent'
            const element = byId('pdfContent');
            if (!element) {
                alert('Please generate the PDF report first by clicking "Generate PDF Report".');
                return;
            }

            showLoading();

            const customerName = window.currentInputData?.custName
                ? window.currentInputData.custName.replace(/\s+/g, '_')
                : 'Customer';
            const filename = `Zzorba_Eligibility_Report_${customerName}_${new Date().getTime()}.pdf`;

            html2canvas(element, {
                scale: 2,
                useCORS: true, // Essential for external images
                allowTaint: true,
                logging: false,
                windowWidth: element.scrollWidth,
                windowHeight: element.scrollHeight
            }).then(canvas => {
                if (window.jsPDF) {
                    const pdf = new window.jsPDF('p', 'mm', 'a4');
                    const imgData = canvas.toDataURL('image/jpeg', 1.0);

                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    const imgWidth = pageWidth - 20; // Margin
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;

                    let heightLeft = imgHeight;
                    let position = 10; // Top margin

                    pdf.addImage(imgData, 'JPEG', 10, position, imgWidth, imgHeight);
                    heightLeft -= (pageHeight - 20);

                    while (heightLeft > 0) {
                        position = heightLeft - imgHeight + 10; // Adjust position for subsequent pages
                        pdf.addPage();
                        pdf.addImage(imgData, 'JPEG', 10, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    pdf.save(filename);
                } else {
                    alert('PDF library not loaded. Please refresh and try again.');
                }
                hideLoading();
            }).catch(error => {
                console.error('PDF generation error:', error);
                alert('Failed to generate PDF. The logo image might be causing an issue. Please try again.');
                hideLoading();
            });
        }

        // Reset Form Function
        function resetForm() {
            if (confirm('Are you sure you want to reset all data?')) {
                calculationCompleted = false;
                location.reload();
            }
        }

        // Initialize everything when page loads
        window.addEventListener('load', () => {
            if (!window.jsPDF && window.jspdf && window.jspdf.jsPDF) {
                window.jsPDF = window.jspdf.jsPDF;
            }
        });
    </script>
</body>

</html>
